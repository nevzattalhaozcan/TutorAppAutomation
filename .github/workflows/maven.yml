name: Android Appium Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Enable KVM
      run: |
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
        sudo udevadm control --reload-rules
        sudo udevadm trigger --name-match=kvm

    - name: Install Appium
      run: |
        npm install -g appium
        appium driver install uiautomator2

    - name: Create Config Properties
      run: |
        mkdir -p src/main/resources
        echo "platform=Android" > src/main/resources/config.properties
        echo "appium.server.url=http://127.0.0.1:4723" >> src/main/resources/config.properties
        echo "appium.timeout=30" >> src/main/resources/config.properties
        echo "implicit.wait=15" >> src/main/resources/config.properties
        echo "explicit.wait=30" >> src/main/resources/config.properties
        echo "test.user.email=purrfectprose@gmail.com" >> src/main/resources/config.properties
        echo "test.user.password=123456" >> src/main/resources/config.properties
        echo "test.user.name=Mehmet Yilmaz" >> src/main/resources/config.properties
        echo "test.student.name=Merve Eren" >> src/main/resources/config.properties
        echo "android.app=app-prod-release.apk" >> src/main/resources/config.properties
        echo "android.app.package=com.deta" >> src/main/resources/config.properties
        echo "android.app.activity=com.deta.app.MainActivity" >> src/main/resources/config.properties
        echo "android.avd.device=test_device" >> src/main/resources/config.properties

    - name: Run Appium Tests
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 29
        target: google_apis
        arch: x86_64
        profile: Nexus 6
        avd-name: test_device
        force-avd-creation: true
        ram-size: 3072M
        heap-size: 1024M
        emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -feature -Vulkan
        disable-animations: true
        script: |
          adb devices
          adb wait-for-device
          adb shell input keyevent 82
          appium --log-level error &
          sleep 15
          mvn clean test -Dtest=HomeworkTest -Dandroid.avd.device=test_device -Dandroid.app=$GITHUB_WORKSPACE/app-prod-release.apk

    - name: Get Allure history
      uses: actions/checkout@v4
      if: always()
      continue-on-error: true
      with:
        ref: gh-pages
        path: gh-pages

    - name: Generate Allure Report
      uses: simple-elf/allure-report-action@master
      if: always()
      with:
        allure_results: target/allure-results
        allure_history: allure-history
        keep_reports: 20

    - name: Deploy report to Github Pages
      if: always()
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_branch: gh-pages
        publish_dir: allure-history
